# Tutorial Básico: CRUD con Next.js y Prisma usando Server Actions

Este tutorial explica cómo construir una aplicación CRUD básica con **Next.js 14** (App Router), **Prisma**, y **Server Actions**, sin usar rutas API. Usaremos un archivo `actions.tsx` para las operaciones del servidor y una base de datos PostgreSQL. El contenido está diseñado para ser claro y práctico, ideal para principiantes.

## Requisitos Previos

- **Node.js**: Versión 18 o superior.
- **PostgreSQL**: Una base de datos configurada (puedes usar servicios como Vercel Postgres o un servidor local).
- **Conocimientos básicos**: JavaScript, React, y TypeScript (opcional, pero recomendado).
- Un editor de código como **VS Code**.

## Configuración del Proyecto

1. **Crea un proyecto Next.js**:
   Ejecuta el siguiente comando para inicializar un proyecto con TypeScript y Tailwind CSS:

   ```bash
   npx create-next-app@latest my-crud-app --typescript --tailwind --eslint
   ```

   Selecciona las opciones predeterminadas, asegurándote de usar el **App Router**.

2. **Instala Prisma**:
   Navega al directorio del proyecto y añade Prisma:

   ```bash
   cd my-crud-app
   npm install prisma --save-dev
   npx prisma init
   ```

   Esto crea una carpeta `prisma` con un archivo `schema.prisma` y un archivo `.env`.

3. **Configura la base de datos**:
   En `.env`, configura la URL de conexión a tu base de datos PostgreSQL, por ejemplo:

   ```env
   DATABASE_URL="postgresql://user:password@localhost:5432/mydb?schema=public"
   ```

   Asegúrate de reemplazar `user`, `password`, y `mydb` con tus credenciales.

4. **Define el modelo en Prisma**:
   Edita `prisma/schema.prisma` para definir el modelo `Task`:

   ```prisma
   generator client {
     provider = "prisma-client-js"
   }

   datasource db {
     provider = "postgresql"
     url      = env("DATABASE_URL")
   }

   model Task {
     id          Int      @id @default(autoincrement())
     title       String   @db.VarChar(255)
     description String?
     createdAt   DateTime @default(now())
     updatedAt   DateTime @updatedAt
   }
   ```

5. **Sincroniza la base de datos**:
   Para sincronizar el esquema con la base de datos sin necesidad de migraciones manuales durante el desarrollo, ejecuta:

   ```bash
   npx prisma db push
   ```

   **Crear una migración**: Si deseas gestionar los cambios en la base de datos de forma controlada (recomendado para entornos de producción), genera y aplica una migración con:

   ```bash
   npx prisma migrate dev --name init
   ```

   Este comando crea una migración llamada `init` en la carpeta `prisma/migrations` y aplica los cambios a la base de datos. El nombre `init` puede cambiarse por uno descriptivo según el contexto (por ejemplo, `add_task_model`).

6. **Instala el cliente de Prisma**:
   Instala la dependencia para interactuar con la base de datos:

   ```bash
   npm install @prisma/client
   ```

## Crear el Archivo actions.tsx

Crea un archivo `app/actions.tsx` para manejar las operaciones CRUD usando **Server Actions**. Este archivo contendrá las funciones del servidor para crear, leer, actualizar y eliminar tareas.

```tsx
// app/actions.tsx
'use server';

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { prisma } from '../lib/prisma';

// Esquema de validación para crear/actualizar tareas
const TaskSchema = z.object({
  title: z.string().min(1, 'El título es requerido').max(255),
  description: z.string().optional(),
});

// Crear una tarea
export async function createTask(formData: FormData) {
  try {
    const { title, description } = TaskSchema.parse({
      title: formData.get('title'),
      description: formData.get('description'),
    });

    await prisma.task.create({
      data: {
        title,
        description,
      },
    });

    revalidatePath('/'); // Refresca la página principal
    return { success: true, error: null };
  } catch {
    return { success: false, error: 'Error al crear la tarea' };
  }
}

// Leer todas las tareas
export async function getTasks() {
  try {
    const tasks = await prisma.task.findMany({
      orderBy: { createdAt: 'desc' },
    });
    return { tasks, error: null };
  } catch {
    return { tasks: [], error: 'Error al obtener las tareas' };
  }
}

// Actualizar una tarea
export async function updateTask(formData: FormData) {
  try {
    const id = parseInt(formData.get('id') as string);
    const { title, description } = TaskSchema.parse({
      title: formData.get('title'),
      description: formData.get('description'),
    });

    await prisma.task.update({
      where: { id },
      data: { title, description },
    });

    revalidatePath('/'); // Refresca la página principal
    return { success: true, error: null };
  } catch {
    return { success: false, error: 'Error al actualizar la tarea' };
  }
}

// Eliminar una tarea
export async function deleteTask(formData: FormData) {
  try {
    const id = parseInt(formData.get('id') as string);
    await prisma.task.delete({
      where: { id },
    });

    revalidatePath('/'); // Refresca la página principal
    return { success: true, error: null };
  } catch {
    return { success: false, error: 'Error al eliminar la tarea' };
  }
}
```

### Explicación del Código

- **`'use server'`**: Indica que estas funciones se ejecutan en el servidor, habilitando Server Actions.
- **Prisma Client**: Importamos `prisma` desde un archivo `lib/prisma.ts` (creado más adelante) para interactuar con la base de datos.
- **Zod**: Usamos la librería `zod` para validar los datos de entrada en las operaciones de creación y actualización.
- **`revalidatePath`**: Refresca la caché de la página principal (`/`) después de cada mutación para reflejar los cambios.
- **Operaciones CRUD**:
  - `createTask`: Crea una nueva tarea.
  - `getTasks`: Obtiene todas las tareas ordenadas por fecha de creación.
  - `updateTask`: Actualiza una tarea existente.
  - `deleteTask`: Elimina una tarea por su ID.

Para usar `zod`, instala la dependencia:

```bash
npm install zod
```

Crea el archivo `lib/prisma.ts` para inicializar el cliente de Prisma:

```ts
// lib/prisma.ts

import { PrismaClient } from "@/generated/prisma";


const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ['query'],
  });

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

## Componente Principal (page.tsx)

Edita `app/page.tsx` para crear una interfaz que liste tareas, permita crear nuevas tareas y editar/eliminar existentes. Este componente usa Server Actions para interactuar con la base de datos.

```tsx
// app/page.tsx
import { getTasks, createTask, updateTask, deleteTask } from '@/app/actions';

export default async function Home() {
  const { tasks, error } = await getTasks();

  return (
    <main className="flex min-h-screen flex-col items-center justify-start bg-gray-50 p-8">
      <div className="w-full max-w-2xl">
        <h1 className="text-4xl font-bold mb-8 text-center text-gray-800">
          Lista de Tareas
        </h1>

        {/* Formulario para crear tarea */}
        <form
          action={createTask}
          className="mb-10 bg-white shadow-md rounded-lg p-6 flex flex-col gap-4"
        >
          <input
            type="text"
            name="title"
            placeholder="Título"
            className="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
            required
          />
          <textarea
            name="description"
            placeholder="Descripción"
            className="border border-gray-300 p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none min-h-[60px]"
          />
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold transition-colors"
          >
            Crear Tarea
          </button>
        </form>

        {/* Lista de tareas */}
        {error && (
          <p className="text-red-500 text-center mb-4">{error}</p>
        )}
        <div className="grid gap-6">
          {tasks.map((task) => (
            <div
              key={task.id}
              className="bg-white shadow rounded-lg p-6 flex flex-col gap-2"
            >
              <div className="flex items-center justify-between gap-2">
                <h2 className="text-xl font-semibold text-gray-700">
                  {task.title}
                </h2>
                <div className="flex gap-2">
                  {/* Formulario para eliminar */}
                  <form action={deleteTask} className="inline">
                    <input type="hidden" name="id" value={task.id} />
                    <button
                      type="submit"
                      className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors font-semibold"
                    >
                      Eliminar
                    </button>
                  </form>
                </div>
              </div>
              <p className="text-gray-600 mb-2">{task.description}</p>
              {/* Formulario para actualizar */}
              <form
                action={updateTask}
                className="flex flex-col md:flex-row gap-2 items-center"
              >
                <input type="hidden" name="id" value={task.id} />
                <input
                  type="text"
                  name="title"
                  defaultValue={task.title}
                  className="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-green-400 flex-1"
                  required
                />
                <textarea
                  name="description"
                  defaultValue={task.description || ''}
                  className="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-green-400 flex-1 resize-none min-h-[40px]"
                />
                <button
                  type="submit"
                  className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 font-semibold transition-colors"
                >
                  Actualizar
                </button>
              </form>
            </div>
          ))}
        </div>
      </div>
    </main>
  );
}
```

### Explicación del Componente

- **Obtener tareas**: La función `getTasks` se ejecuta en el servidor para cargar las tareas al renderizar la página.
- **Crear tarea**: Un formulario usa la acción `createTask` para enviar datos al servidor.
- **Actualizar/Eliminar**: Cada tarea tiene formularios para actualizar y eliminar, usando `updateTask` y `deleteTask`.
- **Estilo**: Usamos Tailwind CSS para un diseño simple y responsive.

## Iniciar el Proyecto

1. **Ejecuta el servidor de desarrollo**:

   ```bash
   npm run dev
   ```

2. Abre `http://localhost:3000` en tu navegador. Verás un formulario para crear tareas y una lista de tareas con opciones para actualizarlas o eliminarlas.

3. **Prueba el CRUD**:
   - Crea una tarea completando el formulario.
   - Actualiza una tarea editando los campos en la lista.
   - Elimina una tarea usando el botón correspondiente.

## Notas Adicionales

- **Server Actions**: Este enfoque elimina la necesidad de rutas API al ejecutar las operaciones directamente en el servidor, aprovechando las capacidades de Next.js 14.
- **Validación**: Usamos `zod` para validar los datos de entrada, asegurando que el título sea obligatorio y no exceda los 255 caracteres.
- **Revalidación**: La función `revalidatePath` asegura que la página se actualice después de cada operación CRUD.
- **Migraciones en Prisma**: El comando `npx prisma migrate dev --name init` crea una migración para versionar los cambios en el esquema de la base de datos, lo que es ideal para entornos de producción o trabajo en equipo.
- **Prisma Studio**: Para inspeccionar los datos en la base de datos, ejecuta:

   ```bash
   npx prisma studio
   ```

   Esto abre una interfaz gráfica en `http://localhost:5555` para gestionar las tareas.

